import{_ as l,J as p,o as e,c as t,k as n,N as o,W as s}from"./chunks/framework.fc3a633d.js";const c="/assets/image-swagger.196c2f42.png",r="/assets/image-swagger1.8082ed5a.png",T=JSON.parse('{"title":"NestJS系列：使用swagger生成路由文档及进阶用法","description":"","frontmatter":{"title":"NestJS系列：使用swagger生成路由文档及进阶用法","date":"2023-08-07T00:00:00.000Z"},"headers":[],"relativePath":"tools/post-wagger.md","filePath":"tools/post-wagger.md"}'),y={name:"tools/post-wagger.md"},i=s(`<p>在 NestJS 中用上 Swagger 是比较简单的，但搜了一圈下来讲进阶用法的好像没多少，最近在用这个时发现了一些好玩的功能，在这里记录下。</p><h2 id="安装" tabindex="-1">安装 <a class="header-anchor" href="#安装" aria-label="Permalink to &quot;安装&quot;">​</a></h2><p>NestJS 提供有 swagger 模块，按官方文档安装就行。</p><ol><li>安装依赖</li></ol><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-light"><code><span class="line"><span style="color:#6F42C1;">pnpm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">@nestjs/swagger</span></span></code></pre></div><ol start="2"><li>新增 <code>src/common/swagger/index.ts</code> 文件(个人习惯，直接在 <code>src/main.ts</code> 文件中使用也行)</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-light"><code><span class="line"><span style="color:#D73A49;">export</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">initSwagger</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> (</span><span style="color:#E36209;">app</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">INestApplication</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">docConfig</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">new</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DocumentBuilder</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">setTitle</span><span style="color:#24292E;">(</span><span style="color:#032F62;">\`接口文档\`</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">setVersion</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;1.0&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">setDescription</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Openapi 3.0文档&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">setExternalDoc</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;JSON数据&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">\`openapi.json\`</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;user&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;用户管理&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;auth&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;认证管理&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;role&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;角色管理&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;permission&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;权限管理&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;post&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;文章管理&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addTag</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;upload&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;文件上传&#39;</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">addBearerAuth</span><span style="color:#24292E;">()</span></span>
<span class="line"><span style="color:#24292E;">    .</span><span style="color:#6F42C1;">build</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">document</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">addResponseWrapper</span><span style="color:#24292E;">(SwaggerModule.</span><span style="color:#6F42C1;">createDocument</span><span style="color:#24292E;">(app, docConfig, options));</span></span>
<span class="line"><span style="color:#24292E;">  SwaggerModule.</span><span style="color:#6F42C1;">setup</span><span style="color:#24292E;">(config.apiDocPrefix, app, document, {</span></span>
<span class="line"><span style="color:#24292E;">    jsonDocumentUrl: </span><span style="color:#032F62;">\`openapi.json\`</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    yamlDocumentUrl: </span><span style="color:#032F62;">\`openapi.yaml\`</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    customfavIcon: </span><span style="color:#032F62;">&#39;/favicon.ico&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">    customSiteTitle: </span><span style="color:#032F62;">\`OpenApi 接口文档\`</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  });</span></span>
<span class="line"><span style="color:#24292E;">};</span></span></code></pre></div><p>其中，<code>new DocumentBuilder</code> 是构建 OpenApi 文档对象的基本参数，基本的对应如下：</p>`,8),d=s(`<p>在 <code>SwaggerModule.setup</code> 函数中，我们传入了一些自定义参数，主要是定义页面的一些样式和路径：</p><ul><li>jsonDocumentUrl: 默认访问json格式数据的路径是 openapi-json, 这里修改为 openapi.json 更易于理解些</li><li>yamlDocumentUrl: 访问 YAML 格式数据的路径，同上</li><li>customfavIcon: 站点图标</li><li>customSiteTitle: 站点标题</li></ul><ol start="3"><li>在 <code>src/main.ts</code> 中引用即可</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-light"><code><span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">app</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> NestFactory.</span><span style="color:#6F42C1;">create</span><span style="color:#24292E;">();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">initSwagger</span><span style="color:#24292E;">(app);</span></span></code></pre></div><ol start="3"><li>在 <code>src/app.controller.ts</code> 中，使用装饰器试下</li></ol><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-light"><code><span class="line"><span style="color:#005CC5;">TODO</span></span></code></pre></div><ol start="4"><li>等待重启后，就能看到访问效果如下：</li></ol>`,7),E=s(`<h2 id="命令行插件" tabindex="-1">命令行插件 <a class="header-anchor" href="#命令行插件" aria-label="Permalink to &quot;命令行插件&quot;">​</a></h2><p>如果想用得好一点，基本都要在控制器方法周围写满 <code>@ApiXxx</code> 等装饰器，明明已经有 Typescript 类型，还要再写一遍，例如：</p><div class="language-ts"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-light"><code><span class="line"><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">AppController</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  @</span><span style="color:#6F42C1;">ApiResponse</span><span style="color:#24292E;">({ type: String })</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">home</span><span style="color:#24292E;">()</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">return</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;hello, world&#39;</span></span>
<span class="line"><span style="color:#24292E;">  }</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p><code>home</code> 方法已经用 Typescript 标注返回的是 string，我们还要用 <code>@ApiResponse</code> 再标注一遍，显然有点重复。</p><p>好在官方提供了一个脚手架插件，能在 typescript 编译为 JavaScript 时，使用 TypeScript 的元数据反射系统帮助我们收集这些类型数据，从而转为 swagger 文档的数据。</p><p>这个插件，大致提供了以下功能：</p><ul><li>自动搜集控制器/方法的 <code>@Query</code> 、 <code>@Body</code> 等装饰器目标的类型，需要注意的是，由于 typescript 会在编译后擦除类型，因此装饰目标不能使用 <code>type</code>/<code>interface</code> 等编译后不存在的类型，而需要使用基本类型(如 <code>string</code>/<code>number</code>)或类(<code>class</code>)。</li><li>根据注释提取为某些字段的值，对于参数，目前注释只支持两部分：描述 和 <code>@example</code> 标签，对于控制器方法，目前支持描述。</li></ul><ol><li>编辑根目录下的 <code>nest-cli.json</code> 文件</li></ol><div class="language-json"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki github-light"><code><span class="line"><span style="color:#24292E;">{</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">&quot;compilerOptions&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">&quot;plugins&quot;</span><span style="color:#24292E;">: [</span></span>
<span class="line"><span style="color:#24292E;">      {</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;name&quot;</span><span style="color:#24292E;">: </span><span style="color:#032F62;">&quot;@nestjs/swagger&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">&quot;options&quot;</span><span style="color:#24292E;">: {</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">&quot;dtoFileNameSuffix&quot;</span><span style="color:#24292E;">: [</span><span style="color:#032F62;">&quot;.vo.ts&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;.dto.ts&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;.entity.ts&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">          </span><span style="color:#005CC5;">&quot;introspectComments&quot;</span><span style="color:#24292E;">: </span><span style="color:#005CC5;">true</span></span>
<span class="line"><span style="color:#24292E;">        }</span></span>
<span class="line"><span style="color:#24292E;">      }</span></span>
<span class="line"><span style="color:#24292E;">    ],</span></span>
<span class="line"><span style="color:#24292E;">  },</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ol start="2"><li>去掉 <code>src/app.controller.ts</code> 中的 <code>@ApiResponse</code></li></ol>`,10);function u(g,C,_,F,m,h){const a=p("Image");return e(),t("div",null,[i,n("p",null,[o(a,{src:c,class:"cursor-pointer"})]),d,n("p",null,[o(a,{src:r,class:"cursor-pointer"})]),E])}const D=l(y,[["render",u]]);export{T as __pageData,D as default};
